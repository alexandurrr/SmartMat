@using smartmat.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Identity.UI.V4.Pages.Internal
@using smartmat.Controllers
@model smartmat.Models.RecipeUserViewModel
@inject UserManager<ApplicationUser> _userManager;
@{
    var recipe = Model.Recipes.FirstOrDefault();
    var review = Model.Reviews.FirstOrDefault();
    System.Diagnostics.Debug.Assert(recipe != null, nameof(recipe) + " != null");
    ViewData["Title"] = recipe.Title;
    var user = await _userManager.GetUserAsync(User);
    var userId = (user == null ? "-1" : user.Id);
}
<style>
    #main {
        text-align: center;
    }
    .tags span {
        font-size: 0.9em;
        border: 1px solid #00000080;
        padding: 0.5em;
        display: inline-block;
        border-radius: 0 1em 1em 1em;
        background-color: #624d4d;
        color: white;
    }
    ul, #instructions {
        text-align: left;
        width: 30em;
        max-width: 100%;
        margin: 1em auto;
    }
    ul {
        list-style-type: none;
        width: 20em;
        padding: 0;
    }
    #background {
        background-image: url("@recipe.ImagePath");
        background-position: center;
        background-size: cover;
        background-repeat: no-repeat;
        width: 100em;
        height: 15em;
        max-width: 100%;
        max-height: 50%;
        box-shadow: 0 0 17px -13px black;
    }
    h1 {
        margin-top: 1em;
    }
    h2 {
        margin: 1em;
    }
    .tags, #bottomLinks {
        margin-top: 1em;
    }
    
   @* **********************************Stars css***************************************' *@
   .star-rating form {
       display: none;
   }
   .star-rating input {
    display: none; 
   }
   .star-rating {
       margin: 50px auto;
       display: table;
       width: 350px;
   }
   .star-rating label {
       padding: 10px;
       float: right;
       font-size: 20px;
       color: #eee;
   }
   .star-rating input:not(:checked) ~ label:hover,
   .star-rating input:not(:checked) ~ label:hover ~ label {
       color: #000000;
   }
   .star-rating input:checked ~ label {
       color: #000000;
   }
   .star-rating form .rating-reaction:before {
       width: 100%;
       float: left;
       color: #000000;
   }
   .star-rating #rating-1:checked ~ form .rating-reaction:before {
     
   }
   .star-rating #rating-2:checked ~ form .rating-reaction:before {
       
   }
   .star-rating #rating-3:checked ~ form .rating-reaction:before {
       
   }
   .star-rating #rating-4:checked ~ form .rating-reaction:before {
       
   }
   .star-rating #rating-5:checked ~ form .rating-reaction:before {
       
   }
   .star-rating input:checked ~ form {
       border-top: 1px solid #ddd;
       width: 100%;
       padding-top: 15px;
       margin-top: 15px;
       display: inline-block;
   }
   .star-rating form .rating-reaction {
       font-size: 24px;
       float: left;
       text-transform: capitalize;
   }
    
</style>

<div id="background"></div>
<h1>@recipe.Title</h1>
<div>
    @if (recipe.Reviews != null)
    {
        var avg = Math.Round(recipe.Reviews.Average(r => r.Stars)/0.5)*0.5;
        var rest = avg % 1;
        var half = rest > 0;
        @for (var i = 0; i < avg-rest; i++)
        {
            <span class="fa fa-star"></span>
        }
        @if (half)
        {
            <span class="fa fa-star-half-o"></span>
        }
        @for (var i = Math.Round(avg); i < 5; i++)
        {
            <span class="fa fa-star-o"></span>
        }
    }
</div>
<p>Av <a asp-action="ByUser" asp-route-id="@recipe.UserId">@recipe.ApplicationUser.UserName</a> (@(recipe.Visibility == "Public" ? "Offentlig" : "Privat"))</p>
<div class="tags">
    @if (recipe.Category != null)
    {
        <span>@recipe.Category</span>   
    }
    @if (recipe.Glutenfree)
    {
        <span>@Html.DisplayNameFor(model => model.Recipes.FirstOrDefault().Glutenfree)</span>
    }
    @if (recipe.Vegetarian)
    {
        <span>@Html.DisplayNameFor(model => model.Recipes.FirstOrDefault().Vegetarian)</span>
    }
</div>
<div>
    <p>@Html.DisplayNameFor(model => model.Recipes.FirstOrDefault().Time) : <span class="timeBubble @(recipe.Time >= 30 ? "orangeBubble" : "blueBubble")"><span>@recipe.Time</span><br><span class="min">min</span></span></p>
    <p>@recipe.Introduction</p>
    <h2>@Html.DisplayNameFor(model => model.Recipes.FirstOrDefault().Ingredients)</h2>
    <ul>
        @foreach (var ingredient in recipe.Ingredients.Split(", "))
        {
            <li>@ingredient</li>
        }
    </ul>
    <h2>@Html.DisplayNameFor(model => model.Recipes.FirstOrDefault().Instructions)</h2>
    <p id="instructions">@recipe.Instructions</p>
    <h2>@Html.DisplayNameFor(model => model.Recipes.FirstOrDefault().Nutrients)</h2>
    <p>@recipe.Nutrients</p>
</div>
<div id="bottomLinks">
        @if (user != null){
            
            var userFavorites = user.Favorites;
            var values = new List<int>();
            if (!string.IsNullOrEmpty(userFavorites))
            {
                userFavorites = userFavorites.Remove(userFavorites.Length - 1);
                values = userFavorites.Split(',').Select(int.Parse).ToList();
            }
            
            @if (!values.Contains(recipe.Id))
            {
                <form asp-action="Favorite">
                    <div class="form-check form-check-inline">
                        <label asp-for="@Model.IsFavorite" class="control-label"></label>
                        <input asp-for="@Model.IsFavorite" value="true" class="form-check-input" onclick="this.form.submit()"/>
                        <input value="@recipe.Id" name="id" type="hidden"/>
                        <span asp-validation-for="@Model.IsFavorite" class="text-danger"></span>
                    </div>
                </form>
            }
            else
            {
                <form asp-action="Favorite">
                    <div class="form-check form-check-inline">
                        <label asp-for="@Model.UnFavorite" class="control-label"></label>
                        <input asp-for="@Model.UnFavorite" value="true" class="form-check-input" onclick="this.form.submit()"/>
                        <input value="@recipe.Id" name="id" type="hidden"/>
                        <span asp-validation-for="@Model.IsFavorite" class="text-danger"></span>
                    </div>
                </form>
            }
          }
        
    @if (recipe.ApplicationUser.Id == userId)
    {
        const string s = "|";
        <a asp-action="Delete" asp-route-id="@recipe.Id">Slett</a>
        @s
        <a asp-action="Edit" asp-route-id="@recipe.Id">Rediger</a>
        @s
    }

        <a asp-action="Index">Se alle oppskrifter</a>
        
        <br />
        <br />
        
            @foreach (var item in Model.Reviews)
            {
                @if (item.RecipeId == recipe.Id)
                     {
                         <br/>
                         <br/>
                         @for (int i = 0; i < item.Stars; i++)
                         {
                             <span class="fa fa-star"></span>
                         } 
                         @for (int i = item.Stars; i < 5; i++)
                         {
                             <span class="fa fa-star-o"></span>
                         }
                         <br/>
                @item.Title
                <br/>
                @item.Description
                         <br/>
                         <p>Skrevet av @item.ApplicationUser</p>
                         <br/><br/>
                     }
        }
        
         <div class="mainDiv container-fluid bg-light shadow rounded">
            <h2 class="standaloneHeader">Gi tilbakemelding</h2>
             <hr />
             <body>
             <meta charset="utf-8" />
             <meta name="viewport" content="width=device-width, initial-scale=1" />
             <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.10.2/css/all.css" />
                     
             
             </body>
             
            <form asp-action="Details" method="post" enctype="multipart/form-data">
                <div class="px-4 pt-0 pb-4 cover" id="inputForm">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    
                    <span class="rating-reaction"></span>
                   <div class="star-rating">
                       <div class="star-input">
                           <input type="radio" asp-for="FormReview.Stars" id="rating-5" value="5" required>
                           
                           <label for="rating-5" class="fas fa-star"></label>
                           <input type="radio" asp-for="FormReview.Stars" id="rating-4" value="4" required>
                           <label for="rating-4" class="fas fa-star"></label>
                           <input type="radio" asp-for="FormReview.Stars" id="rating-3" value="3" required>
                           <label for="rating-3" class="fas fa-star"></label>
                           <input type="radio" asp-for="FormReview.Stars" id="rating-2" value="2" required>
                           <label for="rating-2" class="fas fa-star"></label>
                           <input type="radio" asp-for="FormReview.Stars" id="rating-1" value="1" required>
                           <label for="rating-1" class="fas fa-star"></label>
                                    </div>
                                </div>
                    <input value="@recipe.Id" asp-for="FormReview.RecipeId" type="hidden"/>
                    <div class="form-group">
                        <label asp-for="FormReview.Title" class="control-label"></label>
                        <input asp-for="FormReview.Title" class="form-control" required/>
                        <span asp-validation-for="FormReview.Title" class="text-danger"></span>
                    </div>
                    
                    <div class="form-group">
                        <label asp-for="FormReview.Description" class="control-label"></label>
                        <textarea asp-for="FormReview.Description" class="form-control" required></textarea>
                        <span asp-validation-for="FormReview.Description" class="text-danger"></span>
                    </div>
                    
                    <div class="form-group">
                        <input type="submit" value="Publiser" class="btn btn-primary"/>
                    </div>
                </div>
            </form>
        </div>

        
</div>
